{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/2020/unit-testing-in-angular-to-testbed-or-not-to-testbed","result":{"data":{"markdownRemark":{"html":"<p>I recently started consulting for a new client (no names please). As I began to create a new feature and write unit tests I noticed several things. First that writing tests were more difficult than necessary (I'll get into this more specifically later) and that the Test runner was running very slowly.</p>\n<p>As I began to look deeper into the tests I noticed a difference between my unit tests and the previously written tests from other parts in the app. I discovered that I was using <a href=\"https://angular.io/api/core/testing/TestBed\">TestBed</a> to create my tests. This wasn't the case anywhere else in the app. I found this to be very interesting as I've always used TestBed in the past and performance was not an issue.</p>\n<p>This led me to do some more research on the topic and see if any others in the Angular Community were not using TestBed. I couldn't find many articles but was able to find an episode of <a href=\"https://www.spreaker.com/user/ng-conf/e025-testing-series-part-1-unit-testing\">The Angular Show</a> podcast where <a href=\"https://twitter.com/josepheames\">Joe Eames</a> and <a href=\"https://twitter.com/shai_reznik\">Shai Reznik</a> were having a very healthy debate on why you should or shouldn't use TestBed. I won't spoil the episode for you but I will admit that for someone who works in Angular every day this was the first I had ever heard a case (and a good one at that) for not using TestBed.</p>\n<p>Though I was still skeptical, I figured I would give it a shot on this project and see if it made a difference. I was quickly blown away by the increase in performance this approach brought me. This led me to ask the question of why...which ultimately led to this blog article.</p>\n<h2>Performance</h2>\n<p>When you remove TestBed from your component spec files it essentially no longer tests the DOM. It now only tests the component class itself. This felt like a code smell at first but ultimately the more I thought about it, the more I realized that a true unit test should only be testing <em>one unit</em> of code. How the component's HTML template interacted with its component class really becomes an integration test, testing the integration between the two.</p>\n<p>So let me unpack this a little bit more. When you use the Angular CLI and generate a new component <code>ng g c my-feature</code> it will render the following files:</p>\n<ul>\n<li><code>my-feature.component.html</code></li>\n<li><code>my-feature.component.scss</code></li>\n<li><code>my-feature.component.ts</code></li>\n<li><code>my-feature.component.spec.ts</code></li>\n</ul>\n<p>When you open up the <code>my-feature.component.spec.ts</code> file we see the following:</p>\n<pre><code>import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n\nimport { MyFeatureComponent } from './my-feature.component';\n\ndescribe('MyFeatureComponent', () => {\n  let component: MyFeatureComponent;\n  let fixture: ComponentFixture&#x3C;MyFeatureComponent>;\n\n  beforeEach(async(() => {\n    TestBed.configureTestingModule({\n      declarations: [ MyFeatureComponent ]\n    })\n    .compileComponents();\n  }));\n\n  beforeEach(() => {\n    fixture = TestBed.createComponent(MyFeatureComponent);\n    component = fixture.componentInstance;\n    fixture.detectChanges();\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<p>This essentially before each test will create a new instance of the MyFeatureComponent class and the DOM. This example is trivial but in an application with hundreds of components, generating the DOM for every test can become costly.</p>\n<h4>WITHOUT TestBed</h4>\n<pre><code>import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n\nimport { MyFeatureComponent } from './my-feature.component';\n\ndescribe('MyFeatureComponent', () => {\n  let component: MyFeatureComponent;\n\n  beforeEach(() => {\n    component = new MyFeatureComponent()\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<p>By just newing up the <code>MyFeatureComponent</code> class before each test it will just create the class instance and forgo the DOM itself.</p>\n<h3>What about Dependencies?</h3>\n<p>Let's say our component now has 2 dependencies. One to a <code>UserService</code> and another to a <code>MyFeatureService</code>. How do we handle writing tests that need dependencies provided?</p>\n<h4>WITH TestBed</h4>\n<pre><code>@angular/core/testing';\n\nimport { MyFeatureComponent } from './my-feature.component';\nimport { UserService, MyFeatureService } from 'src/app/services';\n\ndescribe('MyFeatureComponent', () => {\n  let component: MyFeatureComponent;\n  let fixture: ComponentFixture&#x3C;MyFeatureComponent>;\n\n  beforeEach(async(() => {\n    TestBed.configureTestingModule({\n      declarations: [ MyFeatureComponent ],\n      providers: [UserService, MyFeatureService]\n    })\n    .compileComponents();\n  }));\n\n  beforeEach(() => {\n    fixture = TestBed.createComponent(MyFeatureComponent);\n    component = fixture.componentInstance;\n    fixture.detectChanges();\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<h4>WTHOUT TestBed</h4>\n<pre><code>import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n\nimport { MyFeatureComponent } from './my-feature.component';\nimport { UserService, MyFeatureService } from 'src/app/services';\n\ndescribe('MyFeatureComponent', () => {\n  let component: MyFeatureComponent;\n  const userService = new UserService();\n  const myFeatureService = new MyFeatureService();\n\n  beforeEach(() => {\n    component = new MyFeatureComponent(userService, myFeatureService);\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<p>*** Note: The order of dependencies you add into the new Component class instance does need to be in the correct order with this approach.</p>\n<h3>What if my dependencies have dependencies?</h3>\n<p>I know you were probably thinking the same thing when looking at the previous example as most dependencies have other dependencies. For example, a service typically has a dependency upon <code>HttpClient</code> which enables it to make network requests to an API. When this happens (which is almost always) we typically use a mock or a fake.</p>\n<h4>WITH TestBed</h4>\n<pre><code>@angular/core/testing';\n\nimport { MyFeatureComponent } from './my-feature.component';\nimport { UserService, MyFeatureService } from 'src/app/services';\n\nclass FakeMyFeatureService {\n\n}\n\nclass FakeUserService {\n\n}\n\ndescribe('MyFeatureComponent', () => {\n  let component: MyFeatureComponent;\n  let fixture: ComponentFixture&#x3C;MyFeatureComponent>;\n\n  beforeEach(async(() => {\n    TestBed.configureTestingModule({\n      declarations: [ MyFeatureComponent ],\n      providers: [\n        { provide: UserService, useClass: FakeUserService },\n        { provide: MyFeatureService, useClass: FakeMyFeatureService }\n      ]\n    })\n    .compileComponents();\n  }));\n\n  beforeEach(() => {\n    fixture = TestBed.createComponent(MyFeatureComponent);\n    component = fixture.componentInstance;\n    fixture.detectChanges();\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<h4>WITHOUT TestBed</h4>\n<pre><code>import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n\nimport { MyFeatureComponent } from './my-feature.component';\nimport { UserService, MyFeatureService } from 'src/app/services';\n\nclass FakeMyFeatureService {\n\n}\n\nclass FakeUserService {\n\n}\n\ndescribe('MyFeatureComponent', () => {\n  let component: MyFeatureComponent;\n  const userService = new FakeUserService();\n  const myFeatureService = new FakeMyFeatureService();\n\n  beforeEach(() => {\n    component = new MyFeatureComponent(userService, myFeatureService);\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<p>*** Note: You will want to use spies on those dependencies to actually test the parts of your component you care about.</p>\n<h2>Less Flaky Tests</h2>\n<p>Without TestBed, we are no longer testing the DOM itself which means that changes to the DOM will no longer break your tests. I mean how many times have you created a component somewhere in your Angular application all of a sudden tests start failing? This is because TestBed is creating the DOM <code>beforeEach</code> test. When a component and its dependencies are added its parent component will now fail. </p>\n<p>Let's take a look at this more in-depth by creating a parent component called <code>MyParentComponent</code> with <code>ng g c my-parent</code></p>\n<p>Now let's take a look at the <code>my-parent.component.spec.ts</code> file:</p>\n<h3>WITH TestBed</h3>\n<pre><code>@angular/core/testing';\n\nimport { MyParentComponent } from './my-parent.component';\n\ndescribe('MyParentComponent', () => {\n  let component: MyParentComponent;\n  let fixture: ComponentFixture&#x3C;MyParentComponent>;\n\n  beforeEach(async(() => {\n    TestBed.configureTestingModule({\n      declarations: [ MyParentComponent ]\n    })\n    .compileComponents();\n  }));\n\n  beforeEach(() => {\n    fixture = TestBed.createComponent(MyParentComponent);\n    component = fixture.componentInstance;\n    fixture.detectChanges();\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<h4>WITHOUT TestBed</h4>\n<pre><code>import { async, ComponentFixture, TestBed } from '@angular/core/testing';\n\nimport { MyParentComponent } from './my-parent.component';\n\ndescribe('MyParentComponent', () => {\n  let component: MyParentComponent;\n\n  beforeEach(() => {\n    component = new MyParentComponent();\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<p>Now let's add <code>MyFeatureComponent</code> to the template as a child of <code>MyParentComponent</code>.</p>\n<pre><code>&#x3C;my-parent>\n  &#x3C;my-feature />\n&#x3C;/my-parent>\n</code></pre>\n<p>In this example, <code>my-parent.component.spec.ts</code> tests are now all failing as it doesn't have a declaration for <code>MyFeatureComponent</code> or it's providers <code>UserService</code> and <code>MyFeatureService</code>. Below is now what we need to do to get those tests back up and passing.</p>\n<h4>WITH TestBed</h4>\n<pre><code>@angular/core/testing';\n\nimport { MyParentComponent } from './my-parent.component';\nimport { MyFeatureComponent } from './my-feature/my-feature.component';\nimport { UserService, MyFeatureService } from 'src/app/services';\n\nclass FakeMyFeatureService {\n\n}\n\nclass FakeUserService {\n\n}\n\ndescribe('MyParentComponent', () => {\n  let component: MyParentComponent;\n  let fixture: ComponentFixture&#x3C;MyParentComponent>;\n\n  beforeEach(async(() => {\n    TestBed.configureTestingModule({\n      declarations: [ MyParentComponent, MyFeatureComponent ],\n      providers: [\n        { provide: UserService, useClass: FakeUserService },\n        { provide: MyFeatureService, useClass: FakeMyFeatureService }\n      ]\n    })\n    .compileComponents();\n  }));\n\n  beforeEach(() => {\n    fixture = TestBed.createComponent(MyParentComponent);\n    component = fixture.componentInstance;\n    fixture.detectChanges();\n  });\n\n  it('should create', () => {\n    expect(component).toBeTruthy();\n  });\n});\n</code></pre>\n<h4>WITHOUT TestBed</h4>\n<p><img src=\"https://media.giphy.com/media/IcGkqdUmYLFGE/giphy.gif\" alt=\"Thank You\">\n<br />\n<strong>This requires no changes as changes to the template had no effect on the test suite!</strong></p>\n<h2>Other Things To Consider</h2>\n<p>There are some tradeoffs we need to consider by not testing any part of the DOM. The biggest being that we are no longer testing the DOM or the integration between it and it's component class. In most cases, we don't particularly care that when a button is clicked we test that it calls a method on its component class. We tend to trust Angular's (click) event binding to just work. Therefore we mostly care that the method it calls actually works as expected. <em>HOWEVER</em>, because we are no longer testing this integration we no longer have the assurance that another developer on the team accidentally deletes that integration. Or that after refactoring that this particular button calls this specific method.</p>\n<p>I do believe this can be a relatively small tradeoff and that this sort of test can be handled more appropriately using e2e tests. I would also mention that this is not an all or nothing approach to testing. In the instances in your application where you do want to test the integration between the template and its class, you can still use TestBed. You essentially just no longer get the benefits above for the parts that are now using TestBed.</p>\n<p><em>Note:</em> In this example the Angular app was running on Angular version 7. Angular 9 and later now render your applications using IVY which released with some performance improvements for TestBed.</p>\n<h2>Conclusion</h2>\n<p>As you can see from our trivial example, that by removing TestBed from our Angular components spec files we are able to improve the performance of our test runner and are able to remove some of the flakiness. Of course, the magnitude by which your test speed will improve will depend upon the size of your application and the way your application is built. Applications with very large components (which is a bigger code smell) will benefit the most from this approach. Ultimately the biggest benefit to writing tests without TestBed is that you are truly writing unit tests that should be easy to write, more reliable, and provide very quick feedback. The easier, more reliable, and quicker feedback you can get from writing tests the more you can leverage the benefits of unit tests.</p>","frontmatter":{"date":"September 30, 2020","path":"/blog/2020/unit-testing-in-angular-to-testbed-or-not-to-testbed","title":"Unit Testing in Angular. To TestBed or NOT to TestBed","videoUrl":null}}},"pageContext":{}}}